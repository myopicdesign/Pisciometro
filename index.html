<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pisciometro</title>

  <!-- FontAwesome CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      height: 100%;
      width: 100%;
      background: linear-gradient(to bottom, #000000, #1a1a1a);
      font-family: 'Inter', sans-serif;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .app {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 30px;
    }

    .back {
      position: absolute;
      left: 0;
      font-size: 24px;
      cursor: pointer;
    }

    header h1 {
      font-size: 18px;
    }

    .greeting {
      text-align: left;
      margin-bottom: 30px;
    }

    .greeting p {
      font-size: 20px;
      line-height: 1.4;
    }

    .emoji {
      font-size: 22px;
    }

    .circle-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .circle {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      border: 2px solid #ffd54f;
      box-shadow: 0 0 15px #ffd54f;
      background: radial-gradient(circle at center, #222 40%, #111 100%);
      position: relative;
      overflow: hidden;
    }

    .wave-container {
      position: absolute;
      width: 100%;
      height: 100%;
      bottom: 0;
      left: 0;
    }

    .wave,
    .wave-back {
      position: absolute;
      width: 200%;
      height: 200%;
      top: 100%;
      left: -50%;
      border-radius: 40%;
      animation: waveAnim 6s linear infinite;
      background: rgba(255, 213, 79, 0.5);
      z-index: 1;
      transition: top 0.5s ease;
    }

    .wave-back {
      background: rgba(255, 213, 79, 0.25);
      animation: waveAnimReverse 6s linear infinite;
      z-index: 0;
    }

    @keyframes waveAnim {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes waveAnimReverse {
      0% { transform: rotate(360deg); }
      100% { transform: rotate(0deg); }
    }

    .goal {
      margin-bottom: 30px;
    }

    .progress {
      font-size: 22px;
      font-weight: 500;
    }

    .label {
      font-size: 14px;
      color: #ccc;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 30px;
    }

    .icon-btn,
    .drop-btn {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      border: none;
      background: none;
      color: white;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .drop-btn {
      border: 2px solid white;
      font-size: 28px;
      border-radius: 50%;
      width: 55px;
      height: 55px;
      background: none;
      color: white;
    }

    .icon-btn {
      border: none;
      font-size: 24px;
      width: 55px;
      height: 55px;
    }

    #label-container {
      margin-top: 20px;
      text-align: left;
      color: white;
      font-family: monospace;
      font-size: 14px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <span class="back" id="backBtn"><i class="fa-solid fa-angle-left"></i></span>
      <h1>Pisciometro</h1>
    </header>

    <main>
      <div class="greeting">
        <p>Ciao Fabrizio, <span class="emoji">ü§òüèº</span><br>√® ora di pisciare</p>
      </div>

      <div class="circle-wrapper">
        <div class="circle">
          <div class="wave-container">
            <div class="wave-back" id="waveBack"></div>
            <div class="wave" id="wave"></div>
          </div>
        </div>
      </div>

      <div class="goal">
        <div class="progress" id="progress">0 / 2000 ml</div>
        <div class="label">Obiettivo giornaliero</div>
      </div>

      <div class="controls">
        <button class="icon-btn" id="stopBtn" title="Stop">
          <i class="fa-solid fa-pause"></i>
        </button>
        <button class="drop-btn" id="startBtn" title="Avvia">
          <i class="fa-solid fa-play"></i>
        </button>
        <button class="icon-btn" id="resetBtn" title="Reset">
          <i class="fa-solid fa-rotate-right"></i>
        </button>
      </div>

      <div id="label-container"></div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/6grfHoA-2/";

    let recognizer;
    let isListening = false;
    let mlTotal = 0;
    let startTime = 0;

    const progressElem = document.getElementById("progress");
    const labelContainer = document.getElementById("label-container");
    const wave = document.getElementById("wave");
    const waveBack = document.getElementById("waveBack");

    function updateWave(ml) {
      const maxMl = 2000;
      const percent = Math.min(ml / maxMl, 1);
      const topPosition = (1 - percent) * 100;
      wave.style.top = `${topPosition}%`;
      waveBack.style.top = `${topPosition}%`;
      progressElem.textContent = `${Math.floor(ml)} / 2000 ml`;
    }

    async function createModel() {
      const checkpointURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      const model = speechCommands.create(
        "BROWSER_FFT",
        undefined,
        checkpointURL,
        metadataURL
      );

      await model.ensureModelLoaded();
      return model;
    }

    async function startListening() {
  if (isListening) return;

  isListening = true;
  startTime = Date.now(); // <-- aggiorna solo il tempo, NON azzerare mlTotal

  await recognizer.listen(result => {
    const labels = recognizer.wordLabels();
    const scores = result.scores;

    labelContainer.innerHTML = "";
    for (let i = 0; i < labels.length; i++) {
      labelContainer.innerHTML += `${labels[i]}: ${scores[i].toFixed(2)}<br>`;
    }

    const liquidIndex = labels.indexOf("Liquido");
    const liquidScore = liquidIndex >= 0 ? scores[liquidIndex] : 0;

    if (liquidScore >= 0.5 && Date.now() - startTime > 3000) {
      mlTotal += 7.5;
      updateWave(mlTotal);
    }
  }, {
    overlapFactor: 0.5,
    includeSpectrogram: false,
    probabilityThreshold: 0.5
  });
}


    function stopListening() {
      if (!isListening) return;
      recognizer.stopListening();
      isListening = false;
    }

    function reset() {
      stopListening();
      mlTotal = 0;
      updateWave(0);
      labelContainer.innerHTML = "";
    }

    (async () => {
      recognizer = await createModel();

      document.getElementById("startBtn").addEventListener("click", () => {
        startListening();
      });

      document.getElementById("stopBtn").addEventListener("click", () => {
        stopListening();
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        reset();
      });

      document.getElementById("backBtn").addEventListener("click", () => {
        alert("Back button pressed!");
      });

      updateWave(0);
    })();
  </script>
</body>
</html>
